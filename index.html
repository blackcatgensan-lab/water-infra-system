<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>水インフラ管理システム</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <!-- Vue.js 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Mermaid.js CDN (System Blueprint) -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>

  <style>
    /* ============================================================
       CSS Variables & Reset
       ============================================================ */
    :root {
      --primary: #1565C0;
      --primary-light: #1E88E5;
      --primary-dark: #0D47A1;
      --accent: #00BCD4;
      --success: #2E7D32;
      --success-light: #4CAF50;
      --warning: #F57F17;
      --danger: #C62828;
      --danger-light: #EF5350;

      --bg-body: #F0F2F5;
      --bg-card: #FFFFFF;
      --bg-sidebar: #1B2A4A;
      --bg-header: #0F1B33;

      --text-primary: #1A202C;
      --text-secondary: #4A5568;
      --text-muted: #A0AEC0;
      --text-inverse: #FFFFFF;

      --border: #E2E8F0;
      --border-light: #EDF2F7;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.12);

      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;

      --font: 'Inter', 'Noto Sans JP', -apple-system, sans-serif;
      --transition: all 0.2s ease;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font);
      background: var(--bg-body);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ============================================================
       App Shell
       ============================================================ */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* --- Header --- */
    .app-header {
      background: linear-gradient(135deg, var(--bg-header) 0%, var(--bg-sidebar) 100%);
      color: var(--text-inverse);
      display: flex;
      align-items: center;
      padding: 0 24px;
      height: 56px;
      flex-shrink: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .app-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-right: 40px;
    }

    .app-logo .material-icons-outlined {
      font-size: 28px;
      color: var(--accent);
    }

    /* Nav Tabs */
    .nav-tabs {
      display: flex;
      gap: 4px;
      height: 100%;
    }

    .nav-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 20px;
      height: 100%;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      font-weight: 500;
      font-size: 13px;
      user-select: none;
    }

    .nav-tab:hover {
      color: var(--text-inverse);
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-tab.active {
      color: var(--text-inverse);
      border-bottom-color: var(--accent);
      background: rgba(255, 255, 255, 0.08);
    }

    .nav-tab .material-icons-outlined {
      font-size: 20px;
    }

    /* --- Main Content --- */
    .app-main {
      flex: 1;
      overflow: hidden;
      display: flex;
    }

    /* ============================================================
       Loading Overlay
       ============================================================ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      margin-top: 16px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Dropdown */
    .dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      border-bottom: 1px solid var(--border-light);
      transition: background-color 0.2s;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background-color: #f5f5f5;
    }

    /* ============================================================
       Dashboard
       ============================================================ */
    .dashboard {
      padding: 28px;
      overflow-y: auto;
      width: 100%;
    }

    .dashboard-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dashboard-title .material-icons-outlined {
      color: var(--primary);
      font-size: 28px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }

    .stat-card.blue::before {
      background: var(--primary);
    }

    .stat-card.green::before {
      background: var(--success);
    }

    .stat-card.orange::before {
      background: var(--warning);
    }

    .stat-card.red::before {
      background: var(--danger);
    }

    .stat-card.cyan::before {
      background: var(--accent);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin: 4px 0;
    }

    .stat-sub {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .stat-card.blue .stat-value {
      color: var(--primary);
    }

    .stat-card.green .stat-value {
      color: var(--success);
    }

    .stat-card.orange .stat-value {
      color: var(--warning);
    }

    .stat-card.red .stat-value {
      color: var(--danger);
    }

    .stat-card.cyan .stat-value {
      color: var(--accent);
    }

    /* Status breakdown mini bars */
    .status-bar-group {
      margin-top: 12px;
    }

    .status-bar-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status-bar {
      flex: 1;
      height: 6px;
      background: var(--border-light);
      border-radius: 3px;
      overflow: hidden;
    }

    .status-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.6s ease;
    }

    /* Alert list */
    .alert-section {
      margin-top: 8px;
    }

    .alert-section h3 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .alert-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .alert-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      border: 1px solid var(--border-light);
      border-left: 4px solid var(--warning);
      font-size: 13px;
    }

    .alert-item .material-icons-outlined {
      color: var(--warning);
      font-size: 20px;
    }

    /* ============================================================
       Equipment View - Blitz GROW 3-Pane
       ============================================================ */
    .equipment-view {
      display: flex;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* --- Left Pane: Tree --- */
    .left-pane {
      width: 260px;
      min-width: 220px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .pane-header {
      padding: 16px 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .pane-header .material-icons-outlined {
      font-size: 18px;
    }

    .tree-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    /* Tree Node */
    .tree-facility {
      margin-bottom: 4px;
    }

    .tree-facility-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
      transition: var(--transition);
      user-select: none;
    }

    .tree-facility-label:hover {
      background: var(--border-light);
    }

    .tree-facility-label .material-icons-outlined {
      font-size: 18px;
      color: var(--primary);
    }

    .tree-expand {
      font-size: 16px !important;
      color: var(--text-muted) !important;
      transition: transform 0.2s;
    }

    .tree-expand.open {
      transform: rotate(90deg);
    }

    .tree-children {
      padding-left: 12px;
    }

    .tree-equipment {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 16px 7px 28px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-secondary);
      transition: var(--transition);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      margin-right: 8px;
      user-select: none;
    }

    .tree-equipment:hover {
      background: #EBF5FB;
      color: var(--text-primary);
    }

    .tree-equipment.active {
      background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .tree-equipment .material-icons-outlined {
      font-size: 18px;
    }

    /* Type Icons Color */
    .type-icon.機械 {
      color: #E65100;
    }

    .type-icon.電気 {
      color: #F9A825;
    }

    .type-icon.計装 {
      color: #00897B;
    }

    .type-icon.管路 {
      color: #5C6BC0;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      gap: 4px;
    }

    .status-badge.稼働中 {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .status-badge.停止中 {
      background: #FFF3E0;
      color: #E65100;
    }

    .status-badge.故障中 {
      background: #FFEBEE;
      color: #C62828;
    }

    .status-badge.廃棄 {
      background: #ECEFF1;
      color: #546E7A;
    }

    .status-dot-sm {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-dot-sm.稼働中 {
      background: #4CAF50;
    }

    .status-dot-sm.停止中 {
      background: #FF9800;
    }

    .status-dot-sm.故障中 {
      background: #F44336;
      animation: pulse-dot 1.5s infinite;
    }

    .status-dot-sm.廃棄 {
      background: #9E9E9E;
    }

    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    /* --- Center Pane: Detail --- */
    .center-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-body);
    }

    .center-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .detail-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-id {
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      background: #E3F2FD;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .detail-name {
      font-size: 20px;
      font-weight: 700;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
    }

    .detail-card.full {
      grid-column: 1 / -1;
    }

    .detail-card h4 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-card h4 .material-icons-outlined {
      font-size: 18px;
      color: var(--primary);
    }

    .info-table {
      width: 100%;
    }

    .info-table tr {
      border-bottom: 1px solid var(--border-light);
    }

    .info-table tr:last-child {
      border: none;
    }

    .info-table th {
      text-align: left;
      padding: 8px 12px 8px 0;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      width: 120px;
      vertical-align: top;
    }

    .info-table td {
      padding: 8px 0;
      font-size: 13px;
      color: var(--text-primary);
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      gap: 12px;
    }

    .empty-state .material-icons-outlined {
      font-size: 64px;
      opacity: 0.3;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* --- Right Pane: Timeline --- */
    .right-pane {
      width: 320px;
      min-width: 280px;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .timeline-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .timeline-item {
      display: flex;
      gap: 12px;
      padding-bottom: 20px;
      position: relative;
    }

    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 15px;
      top: 32px;
      width: 2px;
      bottom: 0;
      background: var(--border);
    }

    .timeline-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      z-index: 1;
    }

    .timeline-dot .material-icons-outlined {
      font-size: 16px;
      color: #fff;
    }

    .timeline-dot.inspection {
      background: var(--primary);
    }

    .timeline-dot.construction {
      background: var(--danger);
    }

    .timeline-dot.construction.更新 {
      background: var(--success);
    }

    .timeline-dot.construction.新設 {
      background: var(--accent);
    }

    .timeline-body {
      flex: 1;
      min-width: 0;
    }

    .timeline-date {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .timeline-title {
      font-size: 13px;
      font-weight: 600;
      margin: 2px 0;
    }

    .timeline-detail {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .timeline-cost {
      display: inline-block;
      margin-top: 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--danger);
      background: #FFEBEE;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* ============================================================
       Staff View - SmartHR Card Grid
       ============================================================ */
    .staff-view {
      padding: 28px;
      overflow-y: auto;
      width: 100%;
    }

    .staff-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .staff-title .material-icons-outlined {
      color: var(--primary);
      font-size: 28px;
    }

    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .staff-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 28px 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .staff-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }

    .staff-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .staff-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      color: var(--text-inverse);
      font-size: 28px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
    }

    .staff-name {
      font-size: 16px;
      font-weight: 700;
    }

    .staff-role {
      display: inline-block;
      margin-top: 8px;
      padding: 3px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .staff-role.管理者 {
      background: #E8EAF6;
      color: #283593;
    }

    .staff-role.作業員 {
      background: #E0F2F1;
      color: #00695C;
    }

    .staff-email {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .staff-tags {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-top: 14px;
    }

    .skill-tag {
      display: inline-block;
      padding: 3px 10px;
      background: #FFF8E1;
      color: #F57F17;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    /* ============================================================
       Inventory View
       ============================================================ */
    .inventory-view {
      padding: 28px;
      overflow-y: auto;
      width: 100%;
    }

    .inventory-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .inventory-title .material-icons-outlined {
      color: var(--primary);
      font-size: 28px;
    }

    .inv-table {
      width: 100%;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
      overflow: hidden;
    }

    .inv-table thead th {
      background: #F8FAFC;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: left;
      border-bottom: 2px solid var(--border);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .inv-table tbody td {
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    .inv-table tbody tr:hover {
      background: #F8FAFC;
    }

    .inv-table tbody tr:last-child td {
      border-bottom: none;
    }

    .stock-bar {
      width: 80px;
      height: 8px;
      background: var(--border-light);
      border-radius: 4px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
    }

    .stock-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease;
    }

    .low-stock-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #FFEBEE;
      color: var(--danger);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    /* ============================================================
       Modal
       ============================================================ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 90%;
      max-width: 520px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 24px;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    /* ============================================================
       Help View
       ============================================================ */
    .help-view {
      padding: 28px;
      overflow-y: auto;
      width: 100%;
    }

    .help-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .help-title .material-icons-outlined {
      color: var(--primary);
      font-size: 28px;
    }

    .help-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .help-card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
    }

    .help-card h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-dark);
    }

    .help-card h3 .material-icons-outlined {
      font-size: 22px;
    }

    .help-card p {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .help-card ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .help-card li {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .workflow-step {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      position: relative;
    }

    .workflow-step:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 15px;
      top: 32px;
      width: 2px;
      height: calc(100% - 12px);
      background: var(--border-light);
    }

    .step-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
      z-index: 1;
    }

    .step-content h4 {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .step-content p {
      font-size: 12px;
      color: var(--text-muted);
      margin: 0;
    }
  </style>
</head>

<body>
  <div id="app">

    <!-- Loading Overlay -->
    <div v-if="loading" class="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">データを読み込み中...</div>
    </div>

    <!-- Header -->
    <header class="app-header">
      <div class="app-logo">
        <span class="material-icons-outlined">water_drop</span>
        水インフラ管理
      </div>
      <nav class="nav-tabs">
        <div class="nav-tab" :class="{active: currentView === 'help'}" @click="currentView = 'help'">
          <span class="material-icons-outlined">help_outline</span>
          ヘルプ
        </div>
        <div class="nav-tab" :class="{active: currentView === 'dashboard'}" @click="currentView = 'dashboard'">
          <span class="material-icons-outlined">dashboard</span>
          ダッシュボード
        </div>
        <div class="nav-tab" :class="{active: currentView === 'equipment'}" @click="currentView = 'equipment'">
          <span class="material-icons-outlined">precision_manufacturing</span>
          設備管理
        </div>
        <div class="nav-tab" :class="{active: currentView === 'staff'}" @click="currentView = 'staff'">
          <span class="material-icons-outlined">groups</span>
          人材管理
        </div>
        <div class="nav-tab" :class="{active: currentView === 'inventory'}" @click="currentView = 'inventory'">
          <span class="material-icons-outlined">inventory_2</span>
          在庫管理
        </div>
        <div class="nav-tab" :class="{active: currentView === 'qualifications'}"
          @click="currentView = 'qualifications'">
          <span class="material-icons-outlined">school</span>
          資格管理
        </div>
        <div class="nav-tab" :class="{active: currentView === 'organizations'}" @click="currentView = 'organizations'">
          <span class="material-icons-outlined">account_tree</span>
          組織管理
        </div>
        <div class="nav-tab" :class="{active: currentView === 'routes'}" @click="currentView = 'routes'">
          <span class="material-icons-outlined">route</span>
          点検ルート管理
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="app-main">

      <!-- ===== Dashboard ===== -->
      <div v-if="currentView === 'dashboard'" class="dashboard">
        <div class="dashboard-title">
          <span class="material-icons-outlined">dashboard</span>
          ダッシュボード
        </div>

        <!-- Stat Cards -->
        <div class="stat-grid">
          <div class="stat-card blue">
            <div class="stat-label">施設数</div>
            <div class="stat-value">{{ facilities.length }}</div>
            <div class="stat-sub">登録施設</div>
          </div>
          <div class="stat-card cyan">
            <div class="stat-label">設備数</div>
            <div class="stat-value">{{ equipment.length }}</div>
            <div class="stat-sub">
              <div class="status-bar-group">
                <div class="status-bar-item" v-for="(count, status) in statusCounts" :key="status">
                  <span class="status-dot-sm" :class="status"></span>
                  <span>{{ status }}</span>
                  <span style="margin-left:auto; font-weight:600;">{{ count }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">直近30日 異常報告</div>
            <div class="stat-value">{{ dashboardData.recentAlerts || 0 }}</div>
            <div class="stat-sub">要対応アラート</div>
          </div>
          <div class="stat-card green">
            <div class="stat-label">点検実績 (総数)</div>
            <div class="stat-value">{{ inspectionResults.length }}</div>
            <div class="stat-sub">記録済み件数</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-label">在庫アラート</div>
            <div class="stat-value">{{ lowStockItems.length }}</div>
            <div class="stat-sub">安全在庫を下回る物品</div>
          </div>
        </div>

        <!-- Low Stock Alerts -->
        <div v-if="lowStockItems.length > 0" class="alert-section">
          <h3>
            <span class="material-icons-outlined" style="color:var(--warning)">warning</span>
            在庫アラート
          </h3>
          <div class="alert-list">
            <div class="alert-item" v-for="item in lowStockItems" :key="item.Item_ID">
              <span class="material-icons-outlined">inventory_2</span>
              <div>
                <strong>{{ item.Name }}</strong> ({{ item.Item_ID }})
                — 現在庫: <strong style="color:var(--danger)">{{ item.Calculated_Stock }}</strong>
                / 安全在庫: {{ item.Safety_Stock }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Equipment View (Blitz GROW 3-Pane) ===== -->
      <div v-if="currentView === 'equipment'" class="equipment-view">

        <!-- Left Pane: Tree -->
        <aside class="left-pane">
          <div class="pane-header">
            <span class="material-icons-outlined">account_tree</span>
            設備ツリー
            <!-- Hierarchical Add Button -->
            <div class="dropdown-menu-container" style="position:relative; margin-left:12px;">
              <button @click="showAddMenu = !showAddMenu" class="btn-primary"
                style="padding:2px 8px; font-size:11px; height:auto;">
                <span class="material-icons-outlined" style="font-size:14px;">add</span>新規登録
                <span class="material-icons-outlined" style="font-size:14px;">arrow_drop_down</span>
              </button>
              <div v-show="showAddMenu" class="dropdown-content"
                style="position:absolute; top:100%; left:0; background:white; border:1px solid var(--border); border-radius:4px; box-shadow:var(--shadow-md); z-index:10; min-width:120px;">
                <div @click="addFacility(); showAddMenu = false" class="dropdown-item">
                  <span class="material-icons-outlined" style="font-size:14px; vertical-align:middle;">domain</span>
                  施設を追加
                </div>
                <div @click="addEquipment(); showAddMenu = false" class="dropdown-item">
                  <span class="material-icons-outlined"
                    style="font-size:14px; vertical-align:middle;">precision_manufacturing</span> 設備を追加
                </div>
              </div>
            </div>
            <div style="margin-left:auto;">
              <select v-model="treeGroupBy" class="tree-select">
                <option value="facility">施設一覧</option>
                <option value="contract">契約別</option>
                <option value="office">事業所別</option>
              </select>
            </div>
          </div>
          <div class="tree-container">
            <!-- Mode: Facility (Flat) -->
            <template v-if="treeGroupBy === 'facility'">
              <div class="tree-facility" v-for="facility in treeData" :key="facility.Facility_ID">
                <div class="tree-facility-label" @click="facility._open = !facility._open">
                  <span class="material-icons-outlined tree-expand" :class="{open: facility._open}">chevron_right</span>
                  <span class="material-icons-outlined">domain</span>
                  {{ facility.Name }}
                  <span style="margin-left:auto;font-size:11px;color:var(--text-muted)">{{ facility.children.length
                    }}</span>
                </div>
                <div class="tree-children" v-show="facility._open">
                  <div class="tree-equipment" v-for="eq in facility.children" :key="eq.Equipment_ID"
                    :class="{active: selectedEquipment && selectedEquipment.Equipment_ID === eq.Equipment_ID}"
                    @click="selectEquipment(eq)">
                    <span class="material-icons-outlined type-icon" :class="eq.Type">{{ typeIcon(eq.Type) }}</span>
                    {{ eq.Name }}
                    <span class="status-dot-sm" :class="eq.Status" style="margin-left:auto;"></span>
                  </div>
                </div>
              </div>
            </template>

            <!-- Mode: Grouped (Contract/Office) -->
            <template v-else>
              <div class="tree-group" v-for="group in treeData" :key="group.ID">
                <div class="tree-group-label" @click="group._open = !group._open">
                  <span class="material-icons-outlined tree-expand" :class="{open: group._open}">chevron_right</span>
                  <span class="material-icons-outlined">{{ treeGroupBy === 'contract' ? 'description' : 'business'
                    }}</span>
                  {{ group.Name }}
                  <span style="margin-left:auto;font-size:11px;color:var(--text-muted)">{{ group.children.length
                    }}施設</span>
                </div>
                <div class="tree-group-children" v-show="group._open">
                  <!-- Nested Facility -->
                  <div class="tree-facility nested" v-for="facility in group.children" :key="facility.Facility_ID">
                    <div class="tree-facility-label" @click="facility._open = !facility._open">
                      <span class="material-icons-outlined tree-expand"
                        :class="{open: facility._open}">chevron_right</span>
                      <span class="material-icons-outlined">domain</span>
                      {{ facility.Name }}
                    </div>
                    <div class="tree-children" v-show="facility._open">
                      <div class="tree-equipment" v-for="eq in facility.EqChildren" :key="eq.Equipment_ID"
                        :class="{active: selectedEquipment && selectedEquipment.Equipment_ID === eq.Equipment_ID}"
                        @click="selectEquipment(eq)">
                        <span class="material-icons-outlined type-icon" :class="eq.Type">{{ typeIcon(eq.Type) }}</span>
                        {{ eq.Name }}
                        <span class="status-dot-sm" :class="eq.Status" style="margin-left:auto;"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </aside>

        <!-- Center Pane: Detail -->
        <section class="center-pane">
          <div class="center-content" v-if="selectedEquipment">
            <!-- Header -->
            <div class="detail-header">
              <span class="detail-id">{{ selectedEquipment.Equipment_ID }}</span>
              <span class="detail-name">{{ selectedEquipment.Name }}</span>
              <span class="status-badge" :class="selectedEquipment.Status">
                <span class="status-dot-sm" :class="selectedEquipment.Status"></span>
                {{ selectedEquipment.Status }}
              </span>
              <button @click="editEquipment(selectedEquipment)" class="btn-outline"
                style="margin-left:auto; padding:4px 8px; font-size:12px;">
                <span class="material-icons-outlined" style="font-size:16px;">edit</span>件
              </button>
            </div>

            <!-- Info Cards -->
            <div class="detail-grid">
              <div class="detail-card">
                <h4><span class="material-icons-outlined">info</span> 基本情報</h4>
                <table class="info-table">
                  <tr>
                    <th>設備ID</th>
                    <td>{{ selectedEquipment.Equipment_ID }}</td>
                  </tr>
                  <tr>
                    <th>施設</th>
                    <td>{{ facilityName(selectedEquipment.Facility_ID) }}</td>
                  </tr>
                  <tr>
                    <th>種別</th>
                    <td>{{ selectedEquipment.Type }}</td>
                  </tr>
                  <tr>
                    <th>設置日</th>
                    <td>{{ formatDate(selectedEquipment.Installation_Date) }}</td>
                  </tr>
                  <tr>
                    <th>QRコード</th>
                    <td>{{ selectedEquipment.QR_Code }}</td>
                  </tr>
                </table>
              </div>
              <div class="detail-card">
                <h4><span class="material-icons-outlined">analytics</span> ステータスサマリ</h4>
                <table class="info-table">
                  <tr>
                    <th>稼働状態</th>
                    <td><span class="status-badge" :class="selectedEquipment.Status"><span class="status-dot-sm"
                          :class="selectedEquipment.Status"></span>{{ selectedEquipment.Status }}</span></td>
                  </tr>
                  <tr>
                    <th>経過年数</th>
                    <td>{{ yearsFromInstall(selectedEquipment.Installation_Date) }} 年</td>
                  </tr>
                  <tr>
                    <th>点検回数</th>
                    <td>{{ inspectionCountFor(selectedEquipment.Equipment_ID) }} 回</td>
                  </tr>
                  <tr>
                    <th>工事件数</th>
                    <td>{{ constructionCountFor(selectedEquipment.Equipment_ID) }} 件</td>
                  </tr>
                </table>
              </div>
            </div>

            <!-- Map Card (placeholder with Google Maps link) -->
            <div class="detail-card full" v-if="selectedFacilityMapLink">
              <h4><span class="material-icons-outlined">map</span> 所在地</h4>
              <div style="background:#E8F5E9;padding:16px;border-radius:var(--radius-sm);text-align:center;">
                <span class="material-icons-outlined"
                  style="font-size:36px;color:var(--success);display:block;margin-bottom:8px;">place</span>
                <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">{{ selectedFacilityAddress }}
                </div>
                <a :href="selectedFacilityMapLink" target="_blank" rel="noopener"
                  style="color:var(--primary);font-weight:600;font-size:13px;text-decoration:none;">
                  Google Maps で開く →
                </a>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div class="center-content" v-else>
            <div class="empty-state">
              <span class="material-icons-outlined">precision_manufacturing</span>
              <p>左のツリーから設備を選択してください</p>
            </div>
          </div>
        </section>

        <!-- Right Pane: Timeline -->
        <aside class="right-pane">
          <div class="pane-header">
            <span class="material-icons-outlined">timeline</span>
            アクティビティ
          </div>
          <div class="timeline-container">
            <div v-if="selectedEquipment && currentTimeline.length > 0">
              <div class="timeline-item" v-for="(event, idx) in currentTimeline" :key="idx">
                <div class="timeline-dot" :class="[event.type, event.category || '']">
                  <span class="material-icons-outlined">
                    {{ event.type === 'inspection' ? 'checklist' : 'build' }}
                  </span>
                </div>
                <div class="timeline-body">
                  <div class="timeline-date">{{ formatDate(event.date) }}</div>
                  <div class="timeline-title">{{ event.title }}</div>
                  <div class="timeline-detail">{{ event.detail }}</div>
                  <div v-if="event.status === '異常'" class="low-stock-badge" style="margin-top:4px;">
                    <span class="material-icons-outlined" style="font-size:14px;">warning</span>
                    異常検知
                  </div>
                  <div v-if="event.cost" class="timeline-cost">¥{{ Number(event.cost).toLocaleString() }}</div>
                </div>
              </div>
            </div>
            <div v-else-if="selectedEquipment" class="empty-state" style="padding-top:60px;">
              <span class="material-icons-outlined" style="font-size:48px;">event_note</span>
              <p>履歴がありません</p>
            </div>
            <div v-else class="empty-state" style="padding-top:60px;">
              <span class="material-icons-outlined" style="font-size:48px;">timeline</span>
              <p>設備を選択すると<br>タイムラインが表示されます</p>
            </div>
          </div>
        </aside>
      </div>

      <!-- ===== Staff View (SmartHR Card Grid) ===== -->
      <div v-if="currentView === 'staff'" class="staff-view">
        <div class="staff-title" style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <span class="material-icons-outlined">groups</span>
            人材管理
          </div>
          <button @click="addStaff" class="btn-primary" style="padding:6px 12px; font-size:13px;">
            <span class="material-icons-outlined" style="font-size:18px;">add</span>新規職員の追加
          </button>
        </div>

        <div class="staff-tree-container" style="padding:16px;">
          <!-- 再帰的組織ツリー: renderOrgNode -->
          <template v-for="node in staffTreeData" :key="node.Org_ID">
            <div class="org-group" :style="{ marginBottom: '8px' }">
              <!-- 組織ヘッダー（クリックで開閉） -->
              <div @click="node._open = !node._open"
                style="cursor:pointer; display:flex; align-items:center; padding:8px 12px; border-radius:8px; transition:background 0.15s;"
                :style="{ fontWeight: node.Type === '部' || node.Type === '事業部' ? 'bold' : '600',
                           fontSize: node.Type === '部' || node.Type === '事業部' ? '16px' : node.Type === '事業所' ? '15px' : '14px',
                           background: node._open ? 'rgba(21,101,192,0.04)' : 'transparent' }">
                <span class="material-icons-outlined" :class="{open: node._open}"
                  style="transition:transform 0.2s; margin-right:8px; font-size:18px;">chevron_right</span>
                <span class="material-icons-outlined" style="font-size:18px; margin-right:6px; color:var(--primary);">
                  {{ node.Type === '部' || node.Type === '事業部' ? 'corporate_fare' :
                  node.Type === '事業所' ? 'domain' :
                  node.Type === '課' ? 'groups' : 'person' }}
                </span>
                {{ node.Name }}
                <span style="font-size:11px; color:var(--text-muted); margin-left:8px; font-weight:normal;"
                  v-if="node.Type">[{{ node.Type }}]</span>
                <span style="font-size:11px; color:var(--text-muted); margin-left:4px; font-weight:normal;">
                  ({{ countAllStaff(node) }}名)
                </span>
              </div>

              <!-- 展開コンテンツ -->
              <div v-show="node._open"
                style="padding-left:20px; border-left:2px solid var(--border-light); margin-left:20px; margin-top:4px;">

                <!-- 子組織を再帰表示 -->
                <template v-for="child in node.children" :key="child.Org_ID">
                  <div class="org-group" style="margin-bottom:4px;">
                    <div @click="child._open = !child._open"
                      style="cursor:pointer; display:flex; align-items:center; padding:6px 10px; border-radius:6px; transition:background 0.15s;"
                      :style="{ fontWeight: child.Type === '事業所' ? '600' : '500',
                                 fontSize: child.Type === '事業所' ? '15px' : '14px',
                                 background: child._open ? 'rgba(21,101,192,0.04)' : 'transparent' }">
                      <span class="material-icons-outlined" :class="{open: child._open}"
                        style="transition:transform 0.2s; margin-right:6px; font-size:16px;">chevron_right</span>
                      <span class="material-icons-outlined"
                        style="font-size:16px; margin-right:5px; color:var(--primary-light);">
                        {{ child.Type === '事業所' ? 'domain' : child.Type === '課' ? 'groups' : 'person' }}
                      </span>
                      {{ child.Name }}
                      <span style="font-size:11px; color:var(--text-muted); margin-left:6px; font-weight:normal;"
                        v-if="child.Type">[{{ child.Type }}]</span>
                      <span style="font-size:11px; color:var(--text-muted); margin-left:4px; font-weight:normal;">
                        ({{ countAllStaff(child) }}名)
                      </span>
                    </div>

                    <!-- 子の展開コンテンツ -->
                    <div v-show="child._open"
                      style="padding-left:18px; border-left:2px solid var(--border-light); margin-left:18px; margin-top:4px;">

                      <!-- 孫組織 (3階層目: 課/係) -->
                      <template v-for="grandchild in child.children" :key="grandchild.Org_ID">
                        <div class="org-group" style="margin-bottom:4px;">
                          <div @click="grandchild._open = !grandchild._open"
                            style="cursor:pointer; display:flex; align-items:center; padding:5px 8px; border-radius:6px; font-size:13px; font-weight:500; transition:background 0.15s;"
                            :style="{ background: grandchild._open ? 'rgba(21,101,192,0.03)' : 'transparent' }">
                            <span class="material-icons-outlined" :class="{open: grandchild._open}"
                              style="transition:transform 0.2s; margin-right:5px; font-size:15px;">chevron_right</span>
                            <span class="material-icons-outlined"
                              style="font-size:15px; margin-right:4px; color:var(--text-muted);">groups</span>
                            {{ grandchild.Name }}
                            <span style="font-size:10px; color:var(--text-muted); margin-left:5px;"
                              v-if="grandchild.Type">[{{ grandchild.Type }}]</span>
                            <span style="font-size:10px; color:var(--text-muted); margin-left:4px;">
                              ({{ countAllStaff(grandchild) }}名)
                            </span>
                          </div>
                          <div v-show="grandchild._open"
                            style="padding-left:16px; border-left:2px solid var(--border-light); margin-left:16px; margin-top:4px;">

                            <!-- 曾孫組織 (4階層目: 係) -->
                            <template v-for="ggchild in grandchild.children" :key="ggchild.Org_ID">
                              <div class="org-group" style="margin-bottom:4px;">
                                <div @click="ggchild._open = !ggchild._open"
                                  style="cursor:pointer; display:flex; align-items:center; padding:4px 6px; border-radius:6px; font-size:12px; font-weight:500;">
                                  <span class="material-icons-outlined" :class="{open: ggchild._open}"
                                    style="transition:transform 0.2s; margin-right:4px; font-size:14px;">chevron_right</span>
                                  <span class="material-icons-outlined"
                                    style="font-size:14px; margin-right:3px; color:var(--text-muted);">person</span>
                                  {{ ggchild.Name }}
                                  <span style="font-size:10px; color:var(--text-muted); margin-left:4px;">({{
                                    ggchild.staff.length }}名)</span>
                                </div>
                                <div v-show="ggchild._open"
                                  style="padding-left:14px; margin-left:14px; margin-top:4px;">
                                  <div class="staff-grid" v-if="ggchild.staff.length > 0"
                                    style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px; margin-bottom:8px;">
                                    <div class="staff-card" v-for="s in ggchild.staff" :key="s.Staff_ID"
                                      @click="openStaffModal(s)">
                                      <div class="staff-avatar">{{ s.Name ? s.Name.charAt(0) : '?' }}</div>
                                      <div class="staff-name">{{ s.Name }} <span
                                          style="font-size:11px; font-weight:normal; color:var(--text-muted);">({{
                                          calculateAge(s.Birth_Date) }}歳)</span></div>
                                      <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <span class="staff-role" :class="s.Role">{{ s.Role }}</span>
                                        <button @click.stop="editStaff(s)" class="btn-outline"
                                          style="padding:2px 6px; font-size:11px;"><span class="material-icons-outlined"
                                            style="font-size:14px;">edit</span></button>
                                      </div>
                                      <div class="staff-email">{{ s.Email }}</div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </template>

                            <!-- 孫の直属スタッフ -->
                            <div class="staff-grid" v-if="grandchild.staff.length > 0"
                              style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px; margin-bottom:8px;">
                              <div class="staff-card" v-for="s in grandchild.staff" :key="s.Staff_ID"
                                @click="openStaffModal(s)">
                                <div class="staff-avatar">{{ s.Name ? s.Name.charAt(0) : '?' }}</div>
                                <div class="staff-name">{{ s.Name }} <span
                                    style="font-size:11px; font-weight:normal; color:var(--text-muted);">({{
                                    calculateAge(s.Birth_Date) }}歳)</span></div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                  <span class="staff-role" :class="s.Role">{{ s.Role }}</span>
                                  <button @click.stop="editStaff(s)" class="btn-outline"
                                    style="padding:2px 6px; font-size:11px;"><span class="material-icons-outlined"
                                      style="font-size:14px;">edit</span></button>
                                </div>
                                <div class="staff-email">{{ s.Email }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </template>

                      <!-- 子の直属スタッフ -->
                      <div class="staff-grid" v-if="child.staff.length > 0"
                        style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px; margin-bottom:8px;">
                        <div class="staff-card" v-for="s in child.staff" :key="s.Staff_ID" @click="openStaffModal(s)">
                          <div class="staff-avatar">{{ s.Name ? s.Name.charAt(0) : '?' }}</div>
                          <div class="staff-name">{{ s.Name }} <span
                              style="font-size:11px; font-weight:normal; color:var(--text-muted);">({{
                              calculateAge(s.Birth_Date) }}歳)</span></div>
                          <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="staff-role" :class="s.Role">{{ s.Role }}</span>
                            <button @click.stop="editStaff(s)" class="btn-outline"
                              style="padding:2px 6px; font-size:11px;"><span class="material-icons-outlined"
                                style="font-size:14px;">edit</span></button>
                          </div>
                          <div class="staff-email">{{ s.Email }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>

                <!-- ルートの直属スタッフ -->
                <div class="staff-grid" v-if="node.staff.length > 0"
                  style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px; margin-bottom:8px;">
                  <div class="staff-card" v-for="s in node.staff" :key="s.Staff_ID" @click="openStaffModal(s)">
                    <div class="staff-avatar">{{ s.Name ? s.Name.charAt(0) : '?' }}</div>
                    <div class="staff-name">{{ s.Name }} <span
                        style="font-size:11px; font-weight:normal; color:var(--text-muted);">({{
                        calculateAge(s.Birth_Date) }}歳)</span></div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                      <span class="staff-role" :class="s.Role">{{ s.Role }}</span>
                      <button @click.stop="editStaff(s)" class="btn-outline"
                        style="padding:2px 6px; font-size:11px;"><span class="material-icons-outlined"
                          style="font-size:14px;">edit</span></button>
                    </div>
                    <div class="staff-email">{{ s.Email }}</div>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- ===== Inventory View ===== -->
      <div v-if="currentView === 'inventory'" class="inventory-view">
        <div class="inventory-title" style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <span class="material-icons-outlined">inventory_2</span>
            在庫管理
          </div>
          <button @click="addItem" class="btn-primary" style="padding:6px 12px; font-size:13px;">
            <span class="material-icons-outlined" style="font-size:18px;">add</span>新規物品登録
          </button>
        </div>

        <table class="inv-table">
          <thead>
            <tr>
              <th>物品ID</th>
              <th>物品名</th>
              <th>現在庫</th>
              <th>安全在庫</th>
              <th>在庫レベル</th>
              <th>状態</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="item in inventoryWithStock" :key="item.Item_ID">
              <td style="font-weight:600;color:var(--primary)">{{ item.Item_ID }}</td>
              <td>{{ item.Name }}</td>
              <td style="font-weight:600">{{ item.Calculated_Stock }}</td>
              <td>{{ item.Safety_Stock }}</td>
              <td>
                <div class="stock-bar">
                  <div class="stock-bar-fill" :style="{
                       width: stockPercent(item) + '%',
                       background: item.Is_Below_Safety ? 'var(--danger)' : 'var(--success)'
                     }"></div>
                </div>
              </td>
              <td>
                <span v-if="item.Is_Below_Safety" class="low-stock-badge">
                  <span class="material-icons-outlined" style="font-size:14px;">warning</span>
                  要発注
                </span>
                <span v-else style="color:var(--success);font-size:12px;font-weight:600;">正常</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ===== Help View ===== -->
      <div v-if="currentView === 'help'" class="help-view">
        <div class="help-title">
          <span class="material-icons-outlined">help_outline</span>
          システムガイド & ヘルプ
        </div>
        <!-- ... help content ... -->
        <div class="help-grid">
          <!-- How to use Web App -->
          <div class="help-card">
            <h3><span class="material-icons-outlined">tab</span> 各機能の使い方</h3>
            <ul>
              <li><strong>ダッシュボード:</strong> 異常検知や在庫不足などの緊急性の高い情報を一目で確認できます。</li>
              <li><strong>設備管理 (3ペイン):</strong>
                <br>1. 左で設備を選択
                <br>2. 中央で詳細を確認
                <br>3. 右で過去の履歴（タイムライン）を追跡
              </li>
              <li><strong>人材管理:</strong> 職員の資格や過去の点検実績を確認できます。</li>
              <li><strong>在庫管理:</strong> 入出庫ログに基づき現在の理論在庫を自動計算します。</li>
            </ul>
          </div>
          <!-- Workflow -->
          <div class="help-card">
            <h3><span class="material-icons-outlined">account_tree</span> デジタルワークフロー</h3>
            <div class="workflow-step">
              <div class="step-num">1</div>
              <div class="step-content">
                <h4>現場で点検</h4>
                <p>AppSheetで設備QRをスキャン。結果と写真を保存します。</p>
              </div>
            </div>
            <div class="workflow-step">
              <div class="step-num">2</div>
              <div class="step-content">
                <h4>リアルタイム同期</h4>
                <p>データが即座にスプレッドシートへ。異常があればDBにフラグが立ちます。</p>
              </div>
            </div>
            <div class="workflow-step">
              <div class="step-num">3</div>
              <div class="step-content">
                <h4>管理側で確認</h4>
                <p>ダッシュボードにアラートが表示され、管理者はタイムラインで詳細を確認します。</p>
              </div>
            </div>
            <div class="workflow-step">
              <div class="step-num">4</div>
              <div class="step-content">
                <h4>修繕・在庫管理</h4>
                <p>修繕工事を行い、使用した部品をAppSheetでスキャンして在庫を減らします。</p>
              </div>
            </div>
          </div>
          <!-- Version Info -->
          <div class="help-card">
            <h3><span class="material-icons-outlined">history</span> 更新履歴</h3>
            <ul>
              <li><strong>v1.0 (2026/02/14):</strong> 初期リリース。設備・人材・在庫管理機能を実装。</li>
              <li><strong>v1.1 (Developing):</strong> 組織・契約・資格管理機能を追加中。</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- ===== Qualifications View (New Phase 5) ===== -->
      <!-- ===== Qualifications View (New Phase 5) ===== -->
      <div v-if="currentView === 'qualifications'" class="qual-view">
        <div class="header-actions"
          style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <div class="qual-title" style="display:flex; align-items:center; gap:8px;">
            <span class="material-icons-outlined">school</span>
            <span style="font-size:18px; font-weight:bold;">資格・講習管理</span>
          </div>
          <button v-if="qualTab === 'master'" @click="addQualification" class="btn-primary"
            style="padding:6px 12px; font-size:13px;">
            <span class="material-icons-outlined" style="font-size:18px;">add</span>新規資格登録
          </button>
          <button v-if="qualTab === 'applications'" @click="addQualApplication" class="btn-primary"
            style="padding:6px 12px; font-size:13px;">
            <span class="material-icons-outlined" style="font-size:18px;">add</span>新規申込/取得
          </button>
        </div>

        <!-- Sub Tabs -->
        <div class="sub-tabs" style="display:flex; gap:4px; margin-bottom:16px; border-bottom:1px solid var(--border);">
          <div class="sub-tab" :class="{active: qualTab === 'applications'}" @click="qualTab = 'applications'"
            style="padding:8px 16px; cursor:pointer; font-size:13px; font-weight:500; border-bottom:2px solid transparent; transition:all 0.2s;"
            :style="qualTab === 'applications' ? 'border-color:var(--primary); color:var(--primary); background:rgba(21,101,192,0.05);' : 'color:var(--text-muted);'">
            申込・取得状況
          </div>
          <div class="sub-tab" :class="{active: qualTab === 'master'}" @click="qualTab = 'master'"
            style="padding:8px 16px; cursor:pointer; font-size:13px; font-weight:500; border-bottom:2px solid transparent; transition:all 0.2s;"
            :style="qualTab === 'master' ? 'border-color:var(--primary); color:var(--primary); background:rgba(21,101,192,0.05);' : 'color:var(--text-muted);'">
            資格マスタ
          </div>
        </div>

        <!-- Content: Applications -->
        <div v-if="qualTab === 'applications'">
          <table class="inv-table">
            <thead>
              <tr>
                <th>申込ID</th>
                <th>年度</th>
                <th>職員名</th>
                <th>資格名</th>
                <th>ステータス</th>
                <th>申込日</th>
                <th>取得日</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="app in qualApplications" :key="app.App_ID">
                <td style="font-weight:600; color:var(--primary);">{{ app.App_ID }}</td>
                <td>{{ app.Fiscal_Year }}</td>
                <td>{{ getStaffName(app.Staff_ID) }}</td>
                <td>{{ getQualName(app.Qual_ID) }}</td>
                <td>
                  <span class="status-badge" :class="app.Status">{{ app.Status }}</span>
                </td>
                <td>{{ formatDate(app.Application_Date) }}</td>
                <td>
                  {{ formatDate(app.Completion_Date) }}
                  <div v-if="app.Status === '合格' && isExpiringSoon(app.Expiration_Date)"
                    style="color:var(--warning); font-size:10px; font-weight:bold;">
                    <span class="material-icons-outlined" style="font-size:12px; vertical-align:middle;">warning</span>
                    30日以内に期限切れ
                  </div>
                  <div v-if="app.Status === '合格' && isExpired(app.Expiration_Date)"
                    style="color:var(--danger); font-size:10px; font-weight:bold;">
                    <span class="material-icons-outlined"
                      style="font-size:12px; vertical-align:middle;">error_outline</span> 期限切れ
                  </div>
                </td>
                <td style="text-align:center;">
                  <button @click="editQualApplication(app)" class="btn-outline" style="padding:2px 6px;">
                    <span class="material-icons-outlined" style="font-size:16px;">edit</span>
                  </button>
                </td>
              </tr>
              <tr v-if="qualApplications.length === 0">
                <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted);">データがありません</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Content: Master -->
        <div v-if="qualTab === 'master'">
          <table class="inv-table">
            <thead>
              <tr>
                <th>資格ID</th>
                <th>資格名称</th>
                <th>種別</th>
                <th>主催/認定機関</th>
                <th>更新周期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="q in qualifications" :key="q.Qual_ID">
                <td style="font-weight:600; color:var(--primary);">{{ q.Qual_ID }}</td>
                <td>{{ q.Name }}</td>
                <td><span class="skill-tag" style="font-size:11px;">{{ q.Type }}</span></td>
                <td>{{ q.Organizer }}</td>
                <td>{{ q.Renewal_Period_Years > 0 ? q.Renewal_Period_Years + '年' : '-' }}</td>
                <td style="text-align:center;">
                  <button @click="editQualification(q)" class="btn-outline" style="padding:2px 6px; font-size:11px;">
                    <span class="material-icons-outlined" style="font-size:14px;">edit</span>
                  </button>
                </td>
              </tr>
              <tr v-if="qualifications.length === 0">
                <td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">データがありません</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- ===== Organization Management ===== -->
      <div v-if="currentView === 'organizations'" class="inventory-view">
        <div class="pane-header" style="justify-content: space-between; padding: 16px 24px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <span class="material-icons-outlined">account_tree</span>
            <h2 style="margin:0; font-size:18px;">組織管理</h2>
          </div>
          <button @click="addOrganization" class="btn-primary">
            <span class="material-icons-outlined">add</span> 新規組織登録
          </button>
        </div>

        <div style="padding: 0 24px 24px;">
          <table class="inv-table">
            <thead>
              <tr>
                <th style="width: 80px;">順序</th>
                <th style="width: 100px;">組織ID</th>
                <th>組織名</th>
                <th>部署コード</th>
                <th>種別</th>
                <th>上位組織 (パス)</th>
                <th>状態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="org in orderedOrganizations" :key="org.Org_ID"
                :style="org.Is_Active === '無効' ? 'opacity: 0.6; background: #f5f5f5;' : ''">
                <td style="text-align: center;">{{ org.Sort_Order }}</td>
                <td style="font-weight:600; color:var(--primary);">{{ org.Org_ID }}</td>
                <td :style="org.Is_Active === '無効' ? 'text-decoration: line-through;' : 'font-weight: 600;'">{{ org.Name
                  }}</td>
                <td style="font-size: 11px;">{{ org.Org_Code || '-' }}</td>
                <td><span class="skill-tag" style="font-size:11px;">{{ org.Type }}</span></td>
                <td style="font-size:11px; color:var(--text-muted);">{{ getOrgPathOnly(org.Parent_Org_ID) }}</td>
                <td>
                  <span class="status-badge" :class="org.Is_Active === '無効' ? '停止中' : '稼働中'">
                    {{ org.Is_Active || '有効' }}
                  </span>
                </td>
                <td style="text-align:center;">
                  <button @click="editOrganization(org)" class="btn-outline" style="padding:2px 6px; font-size:11px;">
                    <span class="material-icons-outlined" style="font-size:14px;">edit</span>
                  </button>
                </td>
              </tr>
              <tr v-if="organizations.length === 0">
                <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted);">データがありません</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- System Blueprint View (Removed per user request) -->

      <!-- ===== Route Management View (点検ルート管理) ===== -->
      <div v-if="currentView === 'routes'" class="inventory-view">
        <div class="inventory-title">
          <span class="material-icons-outlined">route</span>
          点検ルート管理
          <div style="flex:1;"></div>
          <!-- 将来的な追加ボタン用 -->
          <!-- <button @click="addRoute" class="btn-primary">
            <span class="material-icons-outlined">add</span>
            ルート追加
          </button> -->
        </div>

        <div class="inventory-grid" style="grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));">
          <div v-for="route in inspectionRoutes" :key="route.Route_ID" class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h3 style="margin:0; color:var(--primary-dark);">{{ route.Route_Name }}</h3>
              <span class="status-badge 稼働中">{{ route.Route_ID }}</span>
            </div>

            <div class="detail-section">
              <div class="detail-label">点検順序</div>
              <div class="timeline" style="margin-top:10px;">
                <div
                  v-for="(detail, idx) in routeDetails.filter(d => d.Route_ID === route.Route_ID).sort((a,b) => a.Order - b.Order)"
                  :key="detail.Route_Detail_ID" class="timeline-item">
                  <div class="timeline-dot" style="background:var(--primary);">{{ detail.Order }}</div>
                  <div class="timeline-content">
                    <div style="font-weight:600;">{{ getEquipmentName(detail.Equipment_ID) }}</div>
                    <div style="font-size:11px; color:var(--text-muted);">
                      ID: {{ detail.Equipment_ID }}
                      <span v-if="detail.Instructions" style="margin-left:8px; color:var(--warning-dark);">
                        <span class="material-icons-outlined" style="font-size:12px; vertical-align:middle;">info</span>
                        {{ detail.Instructions }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
              <button @click="selectEquipment(equipment.find(e => e.Equipment_ID === route.Equipment_IDs))"
                v-if="route.Equipment_IDs" class="btn-outline">旧データ表示</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Staff Modal (Tabbed) -->
    <div v-if="staffModal" class="modal-overlay">
      <div class="modal-content" style="position:relative; max-width: 600px;">
        <button class="modal-close" @click="staffModal = null">
          <span class="material-icons-outlined">close</span>
        </button>

        <!-- Profile Header -->
        <div style="display:flex; align-items:center; gap:20px; margin-bottom:24px;">
          <div class="staff-avatar" style="font-size:28px; width:70px; height:70px;">
            {{ staffModal.Name ? staffModal.Name.charAt(0) : '?' }}
          </div>
          <div>
            <div style="font-size:12px; color:var(--text-muted); margin-bottom:2px;">{{ staffModal.Staff_ID }}</div>
            <div class="staff-name" style="font-size:22px;">{{ staffModal.Name }}</div>
            <div style="display:flex; gap:8px; margin-top:4px;">
              <span class="staff-role" :class="staffModal.Role">{{ staffModal.Role }}</span>
              <span v-if="staffModal.Position" class="skill-tag" style="background:#E3F2FD; color:#1565C0;">{{
                staffModal.Position }}</span>
            </div>
          </div>
        </div>

        <!-- Modal Tabs -->
        <div class="sub-tabs"
          style="display:flex; gap:16px; margin-bottom:20px; border-bottom:1px solid var(--border-light);">
          <div class="sub-tab" :class="{active: staffModalTab === 'basic'}" @click="staffModalTab = 'basic'"
            style="padding:8px 4px; cursor:pointer; font-size:14px; font-weight:600; border-bottom:2px solid transparent;"
            :style="staffModalTab === 'basic' ? 'border-color:var(--primary); color:var(--primary);' : 'color:var(--text-muted);'">
            基本情報
          </div>
          <div class="sub-tab" :class="{active: staffModalTab === 'quals'}" @click="staffModalTab = 'quals'"
            style="padding:8px 4px; cursor:pointer; font-size:14px; font-weight:600; border-bottom:2px solid transparent;"
            :style="staffModalTab === 'quals' ? 'border-color:var(--primary); color:var(--primary);' : 'color:var(--text-muted);'">
            資格・経験
          </div>
          <div class="sub-tab" :class="{active: staffModalTab === 'history'}" @click="staffModalTab = 'history'"
            style="padding:8px 4px; cursor:pointer; font-size:14px; font-weight:600; border-bottom:2px solid transparent;"
            :style="staffModalTab === 'history' ? 'border-color:var(--primary); color:var(--primary);' : 'color:var(--text-muted);'">
            異動・昇進履歴
          </div>
        </div>

        <!-- Tab Content -->
        <div class="modal-tab-content">
          <!-- BASIC INFO TAB -->
          <div v-if="staffModalTab === 'basic'">
            <table class="info-table">
              <tr>
                <th>所属</th>
                <td style="font-weight:600;">{{ getOrgFullPath(staffModal.Org_ID) }}</td>
              </tr>
              <tr>
                <th>役職 / 等級</th>
                <td>{{ staffModal.Position || '(未設定)' }} / {{ staffModal.Grade || '-' }}級</td>
              </tr>
              <tr>
                <th>職責</th>
                <td>{{ staffModal.Responsibility || '(未設定)' }}</td>
              </tr>
              <tr>
                <th>メール</th>
                <td>{{ staffModal.Email }}</td>
              </tr>
              <tr>
                <th>連絡先</th>
                <td>
                  <div>携帯: {{ staffModal.Phone }}</div>
                  <div style="font-size:11px; color:var(--text-muted); margin-top:2px;">緊急: {{
                    staffModal.Emergency_Contact }}</div>
                </td>
              </tr>
              <tr>
                <th>生年月日</th>
                <td>{{ formatDate(staffModal.Birth_Date) }} ({{ calculateAge(staffModal.Birth_Date) }}歳)</td>
              </tr>
              <tr>
                <th>入社日</th>
                <td>{{ formatDate(staffModal.Joined_Date) }} (勤続 {{ calculateExperience(staffModal.Joined_Date) }}年)
                </td>
              </tr>
            </table>

            <!-- Operation Buttons -->
            <div style="margin-top:24px; padding:16px; background:#F8FAFC; border-radius:var(--radius-md);">
              <div style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:12px;">人事・組織操作
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button @click="openStaffChangeModal(staffModal, '異動')" class="btn-outline"
                  style="justify-content:center;">
                  <span class="material-icons-outlined" style="font-size:16px;">compare_arrows</span> 組織異動
                </button>
                <button @click="openStaffChangeModal(staffModal, '昇進')" class="btn-outline"
                  style="justify-content:center;">
                  <span class="material-icons-outlined" style="font-size:16px;">trending_up</span> 役職変更
                </button>
                <button @click="openStaffChangeModal(staffModal, '昇格')" class="btn-outline"
                  style="justify-content:center;">
                  <span class="material-icons-outlined" style="font-size:16px;">military_tech</span> 等級昇格
                </button>
                <button @click="openStaffChangeModal(staffModal, '任命')" class="btn-outline"
                  style="justify-content:center;">
                  <span class="material-icons-outlined" style="font-size:16px;">assignment_ind</span> 職責任命
                </button>
              </div>
            </div>
          </div>

          <!-- QUALS TAB -->
          <div v-if="staffModalTab === 'quals'">
            <div style="margin-bottom:20px;">
              <div style="font-weight:700; font-size:13px; margin-bottom:8px;">保有資格</div>
              <div class="staff-tags" style="justify-content:flex-start;">
                <span class="skill-tag" v-for="q in parseQualifications(staffModal.Qualifications)" :key="q">{{ q
                  }}</span>
                <div v-if="!staffModal.Qualifications" style="font-size:12px; color:var(--text-muted);">資格なし</div>
              </div>
            </div>
            <div>
              <div style="font-weight:700; font-size:13px; margin-bottom:8px;">直近の点検実績 (TOP 5)</div>
              <div v-if="staffModalInspections.length > 0">
                <div v-for="ins in staffModalInspections.slice(0, 5)" :key="ins.Result_ID"
                  style="font-size:12px; padding:8px 0; border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between;">
                  <span>{{ formatDate(ins.Timestamp) }} — {{ ins.Equipment_ID }}</span>
                  <span class="status-badge" :class="ins.Status">{{ ins.Status }}</span>
                </div>
              </div>
              <div v-else style="color:var(--text-muted); font-size:12px; padding:12px 0;">点検の記録がありません</div>
            </div>
          </div>

          <!-- HISTORY TAB -->
          <div v-if="staffModalTab === 'history'">
            <div v-if="staffChanges.filter(c => c.Staff_ID === staffModal.Staff_ID).length > 0">
              <div class="timeline-container" style="padding:0;">
                <div class="timeline-item"
                  v-for="change in [...staffChanges].filter(c => c.Staff_ID === staffModal.Staff_ID).reverse()"
                  :key="change.Change_ID">
                  <div class="timeline-dot" style="background:var(--primary);">
                    <span class="material-icons-outlined">{{ change.Change_Type === '異動' ? 'compare_arrows' :
                      'trending_up' }}</span>
                  </div>
                  <div class="timeline-body">
                    <div class="timeline-date">{{ formatDate(change.Change_Date) }}</div>
                    <div class="timeline-title">{{ change.Change_Type }}: {{ change.Field_Changed === 'Org_ID' ? '所属' :
                      change.Field_Changed }}</div>
                    <div class="timeline-detail">
                      <div style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                        <span style="color:var(--text-muted);">{{ change.Old_Value || '-' }}</span>
                        <span class="material-icons-outlined" style="font-size:14px;">arrow_forward</span>
                        <span style="font-weight:600; color:var(--primary);">{{ change.New_Value }}</span>
                      </div>
                      <div v-if="change.Remarks" style="margin-top:4px; font-size:11px; color:var(--text-muted);">
                        備考: {{ change.Remarks }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div v-else class="empty-state" style="padding-top:40px;">
              <span class="material-icons-outlined" style="font-size:40px;">history</span>
              <p>変更履歴は見つかりませんでした</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Staff Change Modal ===== -->
    <div v-if="staffChangeModal.show" class="modal-overlay" style="z-index: 1100;">
      <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
          <h3>
            <span class="material-icons-outlined">assignment_ind</span>
            {{ staffChangeModal.changeType }}の設定
          </h3>
          <button class="close-btn" @click="staffChangeModal.show = false"
            style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body" style="padding-top:15px;" v-if="staffChangeModal.staffData">
          <div style="background:#F1F8E9; padding:12px; border-radius:var(--radius-sm); margin-bottom:16px;">
            <div style="font-size:12px; color:var(--success-dark); font-weight:600;">対象職員</div>
            <div style="font-weight:700;">{{ staffChangeModal.staffData.Name }} ({{ staffChangeModal.staffData.Staff_ID
              }})</div>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label
              style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:var(--text-secondary);">変更後の値</label>
            <select v-model="staffChangeModal.newValue" class="form-control"
              style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:6px; font-size:14px;">
              <option v-for="opt in staffChangeModal.options" :key="opt.value" :value="opt.value"
                :disabled="opt.disabled"
                :style="opt.disabled ? 'font-weight:bold; background:#f5f5f5; color:#333;' : ''">
                {{ opt.label }}
              </option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:15px;">
            <label
              style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:var(--text-secondary);">実施日</label>
            <input type="date" v-model="staffChangeModal.changeDate" class="form-control"
              style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:6px; font-size:14px;">
          </div>

          <div class="form-group">
            <label
              style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:var(--text-secondary);">備考</label>
            <textarea v-model="staffChangeModal.remarks" rows="3" class="form-control"
              style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:6px; font-size:14px; resize:none;"
              placeholder="理由や詳細など"></textarea>
          </div>
        </div>
        <div class="modal-footer" style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
          <button class="btn-outline" @click="staffChangeModal.show = false"
            :disabled="staffChangeModal.saving">キャンセル</button>
          <button class="btn-primary" @click="saveStaffChange" :disabled="staffChangeModal.saving"
            style="background:var(--success); color:white; border:none; padding:10px 24px; border-radius:6px; cursor:pointer; font-weight:700;">
            <span v-if="staffChangeModal.saving" class="material-icons-outlined spin"
              style="font-size:16px; vertical-align:middle; margin-right:4px;">sync</span>
            {{ staffChangeModal.saving ? '処理中...' : '変更を適用する' }}
          </button>
        </div>
      </div>
    </div>

    <!-- ===== Generic Edit Modal (CRUD) ===== -->
    <div v-if="editModal.show" class="modal-overlay">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3>
            <span class="material-icons-outlined">{{ editModal.isNew ? 'add_circle' : 'edit' }}</span>
            {{ editModal.title }}
          </h3>
          <button class="close-btn" @click="editModal.show = false"
            style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body" style="padding-top:15px;">
          <div v-for="field in editModal.fields" :key="field.key" class="form-group" style="margin-bottom:15px;">
            <label style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:var(--text-secondary);">
              {{ field.label }}
            </label>

            <!-- Select -->
            <select v-if="field.type === 'select'" v-model="editModal.data[field.key]" class="form-control"
              style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:6px; font-size:14px;">
              <option v-for="opt in field.options" :key="typeof opt === 'object' ? opt.value : opt"
                :value="typeof opt === 'object' ? opt.value : opt">
                {{ typeof opt === 'object' ? opt.label : opt }}
              </option>
            </select>

            <!-- Date -->
            <input v-else-if="field.type === 'date'" type="date" v-model="editModal.data[field.key]"
              class="form-control"
              style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:6px; font-size:14px;">

            <!-- Number -->
            <input v-else-if="field.type === 'number'" type="number" v-model="editModal.data[field.key]"
              class="form-control"
              style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:6px; font-size:14px;">

            <!-- Default: Text -->
            <input v-else type="text" v-model="editModal.data[field.key]" class="form-control"
              style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:6px; font-size:14px;"
              :readonly="field.readonly && !editModal.isNew">
          </div>
        </div>
        <div class="modal-footer" style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
          <button class="btn-outline" @click="editModal.show = false" :disabled="editModal.saving">キャンセル</button>
          <button v-if="!editModal.isNew" class="btn-danger" @click="handleDelete" style="margin-right:auto;"
            :disabled="editModal.saving">削除</button>
          <button class="btn-primary" @click="handleSave" :disabled="editModal.saving"
            style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">
            <span v-if="editModal.saving" class="material-icons-outlined spin"
              style="font-size:16px; vertical-align:middle; margin-right:4px;">sync</span>
            {{ editModal.saving ? '保存中...' : '保存する' }}
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    const { createApp, ref, computed, onMounted, reactive, watch, nextTick } = Vue;

    createApp({
      setup() {
        // --- Constants ---
        const SHEET = {
          FACILITIES: 'M_Facilities',
          EQUIPMENT: 'M_Equipment',
          INSPECTION_ROUTES: 'M_Inspection_Routes',
          INSPECTION_RESULTS: 'T_Inspection_Results',
          CONSTRUCTION: 'T_Construction_History',
          ITEMS: 'M_Items',
          INVENTORY_LOGS: 'T_Inventory_Logs',
          STAFF: 'M_Staff',
          ORGANIZATIONS: 'M_Organizations',
          CONTRACTS: 'M_Contracts',
          QUALIFICATIONS: 'M_Qualifications',
          QUAL_APPLICATIONS: 'T_Qual_Applications',
          STAFF_CHANGES: 'T_Staff_Changes'
        };

        // --- State ---
        const loading = ref(true);
        const currentView = ref('dashboard');

        const facilities = ref([]);
        const equipment = ref([]);
        const inspectionRoutes = ref([]);
        const routeDetails = ref([]); // [NEW] v2
        const inspectionResults = ref([]);
        const construction = ref([]);
        const items = ref([]);
        const inventoryLogs = ref([]);
        const staff = ref([]);
        const dashboardData = ref({});
        // [NEW] Phase 5
        const organizations = ref([]);
        const contracts = ref([]);
        const qualifications = ref([]);
        const qualApplications = ref([]);
        const staffChanges = ref([]);

        // System Blueprint
        const blueprintText = ref('');
        const isMermaidInitialized = ref(false);

        const selectedEquipment = ref(null);
        const currentTimeline = ref([]);
        const staffModal = ref(null);
        const staffModalTab = ref('basic'); // 'basic', 'quals', 'history'
        const staffModalInspections = ref([]);
        const showAddMenu = ref(false); // [NEW] for Equipment/Facility dropdown
        const qualTab = ref('applications'); // 'master' or 'applications'

        const editModal = reactive({
          show: false,
          saving: false,
          isNew: false,
          title: '',
          sheet: '',
          idColumn: '',
          idValue: '',
          data: {},
          fields: []
        });

        // 人事異動・昇進モーダル
        const staffChangeModal = reactive({
          show: false,
          saving: false,
          staffData: null,
          changeType: '',
          fieldChanged: '',
          oldValue: '',
          newValue: '',
          changeDate: new Date().toISOString().slice(0, 10),
          remarks: '',
          options: []
        });



        const treeGroupBy = ref('facility'); // facility, contract, office
        const filters = reactive({
          fiscalYear: 2025,
          officeId: 'ALL'
        });

        // --- Computed ---
        const statusCounts = computed(() => {
          const counts = { '稼働中': 0, '停止中': 0, '故障中': 0, '廃棄': 0 };
          equipment.value.forEach(e => {
            if (counts[e.Status] !== undefined) counts[e.Status]++;
          });
          return counts;
        });

        const treeData = computed(() => {
          // --- 1. Flat Facility Mode ---
          if (treeGroupBy.value === 'facility') {
            return facilities.value.map(f => {
              const children = equipment.value.filter(e => e.Facility_ID === f.Facility_ID);
              return { ...f, children, _open: true };
            });
          }

          // --- 2. Contract Mode ---
          if (treeGroupBy.value === 'contract') {
            return contracts.value.map(c => {
              // Find facilities for this contract
              const children = facilities.value.filter(f => f.Contract_ID === c.Contract_ID).map(f => {
                const eq = equipment.value.filter(e => e.Facility_ID === f.Facility_ID);
                return { ...f, EqChildren: eq, _open: false };
              });

              // Only include contracts with facilities or always show? 
              // Always show active contracts for visibility
              return {
                ID: c.Contract_ID,
                Name: c.Title,
                children: children,
                _open: true
              };
            });
          }

          // --- 3. Office Mode ---
          if (treeGroupBy.value === 'office') {
            // Offices are Organizations with Type='事業所'
            const offices = organizations.value.filter(o => o.Type === '事業所');

            return offices.map(o => {
              // Office -> Contract -> Facility
              // Find contracts for this office
              const officeContracts = contracts.value.filter(c => c.Office_ID === o.Org_ID);
              const contractIds = officeContracts.map(c => c.Contract_ID);

              // Find facilities linked to these contracts
              const children = facilities.value.filter(f => contractIds.includes(f.Contract_ID)).map(f => {
                const eq = equipment.value.filter(e => e.Facility_ID === f.Facility_ID);
                return { ...f, EqChildren: eq, _open: false };
              });

              return {
                ID: o.Org_ID,
                Name: o.Name,
                children: children,
                _open: true
              };
            });
          }

          return [];
        });



        const officeList = computed(() => {
          return organizations.value.filter(o => o.Type === '事業所');
        });

        const filteredApplications = computed(() => {
          return qualApplications.value.filter(app => {
            // Fiscal Year
            if (app.Fiscal_Year != filters.fiscalYear) return false;

            // Office
            if (filters.officeId !== 'ALL') {
              const s = staff.value.find(s => s.Staff_ID === app.Staff_ID);
              if (!s) return false;
              // Check if staff's org is or belongs to the selected office
              // Simplified: direct match or child
              // Need to traverse up from staff's org to check if it matches filter
              const staffOrg = organizations.value.find(o => o.Org_ID === s.Org_ID);
              if (!staffOrg) return false;

              // If staff org IS the filter
              if (s.Org_ID === filters.officeId) return true;

              // If staff org's parent IS the filter
              if (staffOrg.Parent_Org_ID === filters.officeId) return true;

              return false;
            }
            return true;
          });
        });

        const inventoryWithStock = computed(() => {
          return items.value.map(item => {
            let stock = 0;
            inventoryLogs.value.forEach(log => {
              if (log.Item_ID === item.Item_ID) {
                stock += log.Type === '入庫' ? Number(log.Quantity) : -Number(log.Quantity);
              }
            });
            return {
              ...item,
              Calculated_Stock: stock,
              Is_Below_Safety: stock < item.Safety_Stock
            };
          });
        });

        const orderedOrganizations = computed(() => {
          if (!Array.isArray(organizations.value)) return [];
          return organizations.value.slice().sort((a, b) => {
            const sortA = Number(a.Sort_Order) || 999;
            const sortB = Number(b.Sort_Order) || 999;
            if (sortA !== sortB) return sortA - sortB;
            return (a.Org_ID || '').toString().localeCompare((b.Org_ID || '').toString());
          });
        });

        const lowStockItems = computed(() => {
          return inventoryWithStock.value.filter(i => i.Is_Below_Safety);
        });

        const staffTreeData = computed(() => {
          const orgMap = {};
          // Initialize Map
          organizations.value.forEach(o => {
            orgMap[o.Org_ID] = { ...o, children: [], staff: [], _open: false };
          });
          // Add Staff
          staff.value.forEach(s => {
            if (s.Org_ID && orgMap[s.Org_ID]) {
              orgMap[s.Org_ID].staff.push(s);
            } else {
              if (!orgMap['OTHER']) orgMap['OTHER'] = { Org_ID: 'OTHER', Name: '所属不明', children: [], staff: [], _open: false, Sort_Order: 9999 };
              orgMap['OTHER'].staff.push(s);
            }
          });
          // Build Tree
          const roots = [];
          Object.values(orgMap).forEach(o => {
            if (o.Org_ID === 'OTHER') {
              roots.push(o);
              return;
            }
            if (o.Parent_Org_ID && orgMap[o.Parent_Org_ID]) {
              orgMap[o.Parent_Org_ID].children.push(o);
            } else {
              roots.push(o);
            }
          });

          // Recursive Sort Function with depth protection
          const sortOrg = (orgs, depth = 0) => {
            if (depth > 20) return; // Prevent infinite recursion
            if (!Array.isArray(orgs)) return;
            orgs.sort((a, b) => {
              const sortA = Number(a.Sort_Order) || 999;
              const sortB = Number(b.Sort_Order) || 999;
              if (sortA !== sortB) return sortA - sortB;
              return (a.Org_ID || '').toString().localeCompare((b.Org_ID || '').toString());
            });
            orgs.forEach(o => {
              if (o.children && o.children.length > 0) sortOrg(o.children, depth + 1);
            });
          };

          sortOrg(roots);
          return roots;
        });

        // 組織ノード配下の全スタッフ数を再帰カウント
        function countAllStaff(node) {
          let count = node.staff ? node.staff.length : 0;
          if (node.children) {
            node.children.forEach(c => { count += countAllStaff(c); });
          }
          return count;
        }


        const selectedFacilityMapLink = computed(() => {
          if (!selectedEquipment.value) return '';
          const f = facilities.value.find(f => f.Facility_ID === selectedEquipment.value.Facility_ID);
          return f ? f.Map_Link : '';
        });

        const selectedFacilityAddress = computed(() => {
          if (!selectedEquipment.value) return '';
          const f = facilities.value.find(f => f.Facility_ID === selectedEquipment.value.Facility_ID);
          return f ? f.Address : '';
        });

        // --- Methods ---
        function typeIcon(type) {
          const icons = {
            '機械': 'settings',
            '電気': 'bolt',
            '計装': 'speed',
            '管路': 'route'
          };
          return icons[type] || 'build';
        }

        function facilityName(fid) {
          const f = facilities.value.find(f => f.Facility_ID === fid);
          return f ? f.Name : fid;
        }

        function formatDate(dateStr) {
          if (!dateStr) return '—';
          try {
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            return d.getFullYear() + '/' +
              String(d.getMonth() + 1).padStart(2, '0') + '/' +
              String(d.getDate()).padStart(2, '0');
          } catch (e) { return dateStr; }
        }

        function yearsFromInstall(dateStr) {
          if (!dateStr) return '—';
          const d = new Date(dateStr);
          if (isNaN(d.getTime())) return '—';
          return Math.floor((Date.now() - d.getTime()) / (365.25 * 24 * 60 * 60 * 1000));
        }

        function calculateAge(birthDate) {
          if (!birthDate) return '—';
          const birthday = new Date(birthDate);
          if (isNaN(birthday.getTime())) return '—';
          const today = new Date();
          let age = today.getFullYear() - birthday.getFullYear();
          const m = today.getMonth() - birthday.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < birthday.getDate())) {
            age--;
          }
          return age;
        }

        function calculateExperience(joinedDate) {
          if (!joinedDate) return '—';
          const join = new Date(joinedDate);
          if (isNaN(join.getTime())) return '—';
          const today = new Date();
          let years = today.getFullYear() - join.getFullYear();
          const m = today.getMonth() - join.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < join.getDate())) {
            years--;
          }
          return years;
        }

        function isExpiringSoon(expiryDate) {
          if (!expiryDate) return false;
          const expiry = new Date(expiryDate);
          if (isNaN(expiry.getTime())) return false;
          const today = new Date();
          const diffTime = expiry - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays >= 0 && diffDays <= 30;
        }

        function isExpired(expiryDate) {
          if (!expiryDate) return false;
          const expiry = new Date(expiryDate);
          if (isNaN(expiry.getTime())) return false;
          return expiry < new Date();
        }

        // --- ID to Name Mapping Helpers ---
        function getEquipmentName(id) {
          if (!id) return '-';
          const eq = equipment.value.find(e => String(e.Equipment_ID).trim() === String(id).trim());
          return eq ? eq.Name : id;
        }

        function getStaffName(sid) {
          const s = staff.value.find(x => x.Staff_ID === sid);
          return s ? s.Name : sid;
        }

        function getFacilityName(fid) {
          const f = facilities.value.find(x => x.Facility_ID === fid);
          return f ? f.Name : fid;
        }

        function getQualName(qid) {
          const q = qualifications.value.find(x => x.Qual_ID === qid);
          return q ? q.Name : qid;
        }

        function getOrgFullPath(orgId) {
          if (!orgId) return '';
          const visited = new Set();
          let currentId = orgId;
          const path = [];
          let isInactive = false;

          while (currentId && !visited.has(currentId) && visited.size < 20) {
            visited.add(currentId);
            const org = organizations.value.find(o => o.Org_ID === currentId);
            if (org) {
              path.unshift(org.Name || currentId);
              if (org.Is_Active === '無効') isInactive = true;
              currentId = org.Parent_Org_ID;
            } else {
              if (path.length === 0) path.push(currentId);
              break;
            }
          }
          let fullPath = path.join(' > ');
          return isInactive ? fullPath + ' (無効)' : fullPath;
        }

        function getOrgPathOnly(orgId) {
          if (!orgId) return '-';
          const path = [];
          const visited = new Set();
          let currentId = orgId;
          while (currentId && !visited.has(currentId) && visited.size < 20) {
            visited.add(currentId);
            const org = organizations.value.find(o => o.Org_ID === currentId);
            if (org) {
              path.unshift(org.Name || currentId);
              currentId = org.Parent_Org_ID;
            } else break;
          }
          return path.length > 0 ? path.join(' > ') : '-';
        }

        function inspectionCountFor(eqId) {
          return inspectionResults.value.filter(r => r.Equipment_ID === eqId).length;
        }

        function constructionCountFor(eqId) {
          return construction.value.filter(c => c.Equipment_ID === eqId).length;
        }

        function selectEquipment(eq) {
          selectedEquipment.value = eq;
          buildTimeline(eq.Equipment_ID);
        }

        function buildTimeline(eqId) {
          const timeline = [];

          inspectionResults.value.forEach(r => {
            if (r.Equipment_ID === eqId) {
              timeline.push({
                type: 'inspection',
                date: r.Timestamp,
                title: '定期点検',
                detail: r.Value,
                status: r.Status,
                inspector: r.Inspector_ID
              });
            }
          });

          construction.value.forEach(c => {
            if (c.Equipment_ID === eqId) {
              timeline.push({
                type: 'construction',
                date: c.Start_Date,
                endDate: c.End_Date,
                title: c.Title,
                detail: c.Contractor + ' / ' + c.Category,
                cost: c.Cost,
                category: c.Category
              });
            }
          });

          timeline.sort((a, b) => new Date(b.date) - new Date(a.date));
          currentTimeline.value = timeline;
        }

        function parseQualifications(q) {
          if (!q) return [];
          return String(q).split(',').map(s => s.trim()).filter(Boolean);
        }

        function openStaffModal(s) {
          staffModal.value = s;
          staffModalInspections.value = inspectionResults.value
            .filter(r => r.Inspector_ID === s.Email)
            .sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
        }

        // --- CRUD Methods ---
        function openEditModal(config) {
          editModal.isNew = config.isNew || false;
          editModal.title = config.title;
          editModal.sheet = config.sheet;
          editModal.idColumn = config.idColumn;
          editModal.idValue = config.idValue || '';
          editModal.fields = config.fields;
          editModal.data = { ...config.initialData };
          editModal.saving = false;
          editModal.show = true;
        }

        function handleSave() {
          editModal.saving = true;

          // Staff specific: Join Sei and Mei
          if (editModal.sheet === SHEET.STAFF) {
            const sei = editModal.data.Sei || '';
            const mei = editModal.data.Mei || '';
            editModal.data.Name = (sei + ' ' + mei).trim();
          }

          google.script.run
            .withSuccessHandler(res => {
              editModal.saving = false;
              if (res.success) {
                editModal.show = false;
                // 全データを再取得して画面を更新
                loadAllData();
              } else {
                alert('保存に失敗しました: ' + res.error);
              }
            })
            .withFailureHandler(err => {
              editModal.saving = false;
              alert('保存に失敗しました: ' + err.message);
            })
            .saveData(editModal.sheet, editModal.data, editModal.idColumn, editModal.idValue);
        }

        function handleDelete() {
          if (!confirm('本当に削除してもよろしいですか？')) return;
          editModal.saving = true;
          google.script.run
            .withSuccessHandler(res => {
              editModal.saving = false;
              if (res.success) {
                editModal.show = false;
                loadAllData();
              } else {
                alert('削除に失敗しました: ' + res.error);
              }
            })
            .withFailureHandler(err => {
              editModal.saving = false;
              alert('削除に失敗しました: ' + err.message);
            })
            .deleteRow(editModal.sheet, editModal.idColumn, editModal.idValue);
        }

        function loadAllData() {
          google.script.run
            .withSuccessHandler(data => {
              facilities.value = data.facilities || [];
              equipment.value = data.equipment || [];
              inspectionRoutes.value = data.inspectionRoutes || [];
              inspectionResults.value = data.inspectionResults || [];
              construction.value = data.construction || [];
              items.value = data.items || [];
              inventoryLogs.value = data.inventoryLogs || [];
              staff.value = data.staff || [];
              organizations.value = data.organizations || [];
              contracts.value = data.contracts || [];
              qualifications.value = data.qualifications || [];
              qualApplications.value = data.qualApplications || [];
              staffChanges.value = data.staffChanges || [];
              loading.value = false;
            })
            .getInitialData();
        }


        function stockPercent(item) {
          if (!item.Safety_Stock || item.Safety_Stock === 0) return 100;
          const ratio = (item.Calculated_Stock / (item.Safety_Stock * 3)) * 100;
          return Math.min(100, Math.max(0, ratio));
        }

        // --- View Specific CRUD Helpers ---
        function addFacility() {
          google.script.run
            .withSuccessHandler(nextId => {
              openEditModal({
                isNew: true,
                title: '新規施設登録',
                sheet: SHEET.FACILITIES,
                idColumn: 'Facility_ID',
                fields: [
                  { key: 'Facility_ID', label: '施設ID', type: 'text', readonly: true },
                  { key: 'Name', label: '施設名', type: 'text' },
                  { key: 'Address', label: '住所', type: 'text' },
                  { key: 'Contract_ID', label: '契約ID', type: 'select', options: contracts.value.map(c => c.Contract_ID) },
                  { key: 'Map_Link', label: '地図リンク', type: 'text' },
                  { key: 'Image_URL', label: '画像URL', type: 'text' }
                ],
                initialData: { Facility_ID: nextId }
              });
            })
            .getNextId(SHEET.FACILITIES);
        }

        function addItem() {
          google.script.run
            .withSuccessHandler(nextId => {
              openEditModal({
                isNew: true,
                title: '新規物品登録',
                sheet: SHEET.ITEMS,
                idColumn: 'Item_ID',
                fields: [
                  { key: 'Item_ID', label: '物品ID', type: 'text', readonly: true },
                  { key: 'Name', label: '物品名', type: 'text' },
                  { key: 'Safety_Stock', label: '安全在庫数', type: 'number' },
                  { key: 'Current_Stock', label: '初期在庫数', type: 'number' }
                ],
                initialData: { Item_ID: nextId, Safety_Stock: 10, Current_Stock: 0 }
              });
            })
            .getNextId(SHEET.ITEMS);
        }

        function addQualification() {
          google.script.run
            .withSuccessHandler(nextId => {
              openEditModal({
                isNew: true,
                title: '新規資格登録',
                sheet: SHEET.QUALIFICATIONS,
                idColumn: 'Qual_ID',
                fields: [
                  { key: 'Qual_ID', label: '資格ID', type: 'text', readonly: true },
                  { key: 'Name', label: '資格名称', type: 'text' },
                  { key: 'Type', label: '種別', type: 'select', options: ['国家資格', '技能講習', '特別教育', 'その他'] },
                  { key: 'Organizer', label: '主催/認定機関', type: 'text' },
                  { key: 'Renewal_Period_Years', label: '更新周期(年)', type: 'number' }
                ],
                initialData: { Qual_ID: nextId, Renewal_Period_Years: 0 }
              });
            })
            .getNextId(SHEET.QUALIFICATIONS);
        }

        function editQualification(q) {
          openEditModal({
            isNew: false,
            title: '資格編集',
            sheet: SHEET.QUALIFICATIONS,
            idColumn: 'Qual_ID',
            idValue: q.Qual_ID,
            fields: [
              { key: 'Qual_ID', label: '資格ID', type: 'text', readonly: true },
              { key: 'Name', label: '資格名称', type: 'text' },
              { key: 'Type', label: '種別', type: 'select', options: ['国家資格', '技能講習', '特別教育', 'その他'] },
              { key: 'Organizer', label: '主催/認定機関', type: 'text' },
              { key: 'Renewal_Period_Years', label: '更新周期(年)', type: 'number' }
            ],
            initialData: { ...q }
          });
        }

        function addQualApplication() {
          google.script.run
            .withSuccessHandler(nextId => {
              openEditModal({
                isNew: true,
                title: '新規申込/取得登録',
                sheet: SHEET.QUAL_APPLICATIONS,
                idColumn: 'App_ID',
                fields: [
                  { key: 'App_ID', label: '申込ID', type: 'text', readonly: true },
                  { key: 'Fiscal_Year', label: '年度', type: 'number' },
                  { key: 'Staff_ID', label: '職員名', type: 'select', options: staff.value.map(s => ({ value: s.Staff_ID, label: s.Name })) },
                  { key: 'Qual_ID', label: '資格名称', type: 'select', options: qualifications.value.map(q => ({ value: q.Qual_ID, label: q.Name })) },
                  { key: 'Status', label: 'ステータス', type: 'select', options: ['計画', '申込済', '受講済', '合格', '不合格'] },
                  { key: 'Application_Date', label: '申込日', type: 'date' },
                  { key: 'Completion_Date', label: '取得日/修了日', type: 'date' },
                  { key: 'Expiration_Date', label: '有効期限', type: 'date' },
                  { key: 'License_Number', label: '交付番号', type: 'text' }
                ],
                initialData: { App_ID: nextId, Fiscal_Year: new Date().getFullYear(), Status: '計画' }
              });
            })
            .getNextId(SHEET.QUAL_APPLICATIONS);
        }

        function editQualApplication(a) {
          openEditModal({
            isNew: false,
            title: '申込/取得情報編集',
            sheet: SHEET.QUAL_APPLICATIONS,
            idColumn: 'App_ID',
            idValue: a.App_ID,
            fields: [
              { key: 'App_ID', label: '申込ID', type: 'text', readonly: true },
              { key: 'Fiscal_Year', label: '年度', type: 'number' },
              { key: 'Staff_ID', label: '職員名', type: 'select', options: staff.value.map(s => ({ value: s.Staff_ID, label: s.Name })) },
              { key: 'Qual_ID', label: '資格名称', type: 'select', options: qualifications.value.map(q => ({ value: q.Qual_ID, label: q.Name })) },
              { key: 'Status', label: 'ステータス', type: 'select', options: ['計画', '申込済', '受講済', '合格', '不合格'] },
              { key: 'Application_Date', label: '申込日', type: 'date' },
              { key: 'Completion_Date', label: '取得日/修了日', type: 'date' },
              { key: 'Expiration_Date', label: '有効期限', type: 'date' },
              { key: 'License_Number', label: '交付番号', type: 'text' }
            ],
            initialData: { ...a }
          });
        }

        // --- Organization Management ---
        function addOrganization() {
          google.script.run
            .withSuccessHandler(nextId => {
              openEditModal({
                isNew: true,
                title: '新規組織登録',
                sheet: SHEET.ORGANIZATIONS,
                idColumn: 'Org_ID',
                fields: [
                  { key: 'Org_ID', label: '組織ID', type: 'text', readonly: true },
                  { key: 'Name', label: '組織名', type: 'text' },
                  { key: 'Org_Code', label: '部署コード (連携用)', type: 'text' },
                  { key: 'Type', label: '種別', type: 'select', options: ['部', '事業部', '事業所', '課', '係'] },
                  { key: 'Parent_Org_ID', label: '上位組織', type: 'select', options: [{ value: '', label: '(なし)' }, ...organizations.value.map(o => ({ value: o.Org_ID, label: getOrgFullPath(o.Org_ID) }))] },
                  { key: 'Sort_Order', label: '並び順 (数値)', type: 'number' },
                  { key: 'Is_Active', label: '状態', type: 'select', options: ['有効', '無効'] }
                ],
                initialData: { Org_ID: nextId, Type: '課', Sort_Order: 999, Is_Active: '有効', Org_Code: '' }
              });
            })
            .getNextId(SHEET.ORGANIZATIONS);
        }

        function editOrganization(org) {
          openEditModal({
            isNew: false,
            title: '組織編集',
            sheet: SHEET.ORGANIZATIONS,
            idColumn: 'Org_ID',
            idValue: org.Org_ID,
            fields: [
              { key: 'Org_ID', label: '組織ID', type: 'text', readonly: true },
              { key: 'Name', label: '組織名', type: 'text' },
              { key: 'Org_Code', label: '部署コード (連携用)', type: 'text' },
              { key: 'Type', label: '種別', type: 'select', options: ['部', '事業部', '事業所', '課', '係'] },
              { key: 'Parent_Org_ID', label: '上位組織', type: 'select', options: [{ value: '', label: '(なし)' }, ...organizations.value.map(o => ({ value: o.Org_ID, label: getOrgFullPath(o.Org_ID) }))] },
              { key: 'Sort_Order', label: '並び順 (数値)', type: 'number' },
              { key: 'Is_Active', label: '状態', type: 'select', options: ['有効', '無効'] }
            ],
            initialData: { ...org }
          });
        }

        function addEquipment() {
          google.script.run
            .withSuccessHandler(nextId => {
              openEditModal({
                isNew: true,
                title: '新規設備登録',
                sheet: SHEET.EQUIPMENT,
                idColumn: 'Equipment_ID',
                fields: [
                  { key: 'Equipment_ID', label: '設備ID', type: 'text', readonly: true },
                  { key: 'Facility_ID', label: '施設名称', type: 'select', options: facilities.value.map(f => ({ value: f.Facility_ID, label: f.Name })) },
                  { key: 'Name', label: '設備名', type: 'text' },
                  { key: 'Type', label: '種別', type: 'select', options: ['機械', '電気', '計装', '管路'] },
                  { key: 'Status', label: '状態', type: 'select', options: ['稼働中', '停止中', '故障中', '廃棄'] },
                  { key: 'Installation_Date', label: '設置日', type: 'date' },
                  { key: 'QR_Code', label: 'QRコード', type: 'text' }
                ],
                initialData: { Equipment_ID: nextId, Status: '稼働中', Type: '機械' }
              });
            })
            .getNextId(SHEET.EQUIPMENT);
        }

        function editEquipment(eq) {
          openEditModal({
            isNew: false,
            title: '設備編集',
            sheet: SHEET.EQUIPMENT,
            idColumn: 'Equipment_ID',
            idValue: eq.Equipment_ID,
            fields: [
              { key: 'Equipment_ID', label: '設備ID', type: 'text', readonly: true },
              { key: 'Facility_ID', label: '施設名称', type: 'select', options: facilities.value.map(f => ({ value: f.Facility_ID, label: f.Name })) },
              { key: 'Name', label: '設備名', type: 'text' },
              { key: 'Type', label: '種別', type: 'select', options: ['機械', '電気', '計装', '管路'] },
              { key: 'Status', label: '状態', type: 'select', options: ['稼働中', '停止中', '故障中', '廃棄'] },
              { key: 'Installation_Date', label: '設置日', type: 'date' },
              { key: 'QR_Code', label: 'QRコード', type: 'text' }
            ],
            initialData: { ...eq }
          });
        }

        function addStaff() {
          openEditModal({
            isNew: true,
            title: '新規職員登録',
            sheet: SHEET.STAFF,
            idColumn: 'Staff_ID',
            fields: [
              { key: 'Staff_ID', label: '社員番号', type: 'text' },
              { key: 'Sei', label: '氏', type: 'text' },
              { key: 'Mei', label: '名', type: 'text' },
              { key: 'Kana_Sei', label: '氏（フリガナ）', type: 'text' },
              { key: 'Kana_Mei', label: '名（フリガナ）', type: 'text' },
              { key: 'Email', label: 'メールアドレス', type: 'text' },
              { key: 'Role', label: 'システム役割', type: 'select', options: ['管理者', '作業員'] },
              { key: 'Org_ID', label: '初期配属組織', type: 'select', options: organizations.value.filter(o => o.Is_Active !== '無効').map(o => ({ value: o.Org_ID, label: getOrgFullPath(o.Org_ID) })) },
              { key: 'Position', label: '役職', type: 'select', options: ['', '主任', '係長', '課長補佐', '課長', '所長', '部長'] },
              { key: 'Grade', label: '等級', type: 'select', options: ['', '1', '2', '3', '4', '5', '6', '7', '8'] },
              { key: 'Responsibility', label: '職責', type: 'select', options: ['', '技術員', '技術責任者', '統括責任者'] },
              { key: 'Birth_Date', label: '生年月日', type: 'date' },
              { key: 'Blood_Type', label: '血液型', type: 'select', options: ['A', 'B', 'O', 'AB'] },
              { key: 'Address', label: '現住所', type: 'text' },
              { key: 'Phone', label: '携帯番号', type: 'tel' },
              { key: 'Emergency_Contact', label: '緊急連絡先', type: 'tel' },
              { key: 'Joined_Date', label: '入社年月日', type: 'date' },
              { key: 'Health_Check_Date', label: '直近健康診断日', type: 'date' },
              { key: 'Employment_Status', label: '雇用形態', type: 'select', options: ['正社員', '契約社員', '派遣', 'パート', 'その他'] }
            ],
            initialData: { Staff_ID: '', Role: '作業員', Employment_Status: '正社員' }
          });
        }

        function editStaff(s) {
          // Split Name into Sei and Mei
          let sei = '', mei = '';
          if (s.Name) {
            const parts = s.Name.split(' ');
            sei = parts[0] || '';
            mei = parts.slice(1).join(' ') || '';
          }

          openEditModal({
            isNew: false,
            title: '職員基本情報編集',
            sheet: SHEET.STAFF,
            idColumn: 'Staff_ID',
            idValue: s.Staff_ID,
            fields: [
              { key: 'Staff_ID', label: '社員番号', type: 'text', readonly: true },
              { key: 'Sei', label: '氏', type: 'text' },
              { key: 'Mei', label: '名', type: 'text' },
              { key: 'Kana_Sei', label: '氏（フリガナ）', type: 'text' },
              { key: 'Kana_Mei', label: '名（フリガナ）', type: 'text' },
              { key: 'Email', label: 'メールアドレス', type: 'text' },
              { key: 'Role', label: 'システム役割', type: 'select', options: ['管理者', '作業員'] },
              { key: 'Org_ID', label: '所属組織', type: 'select', options: organizations.value.filter(o => o.Is_Active !== '無効').map(o => ({ value: o.Org_ID, label: getOrgFullPath(o.Org_ID) })) },
              { key: 'Position', label: '役職', type: 'select', options: ['', '主任', '係長', '課長補佐', '課長', '所長', '部長'] },
              { key: 'Grade', label: '等級', type: 'select', options: ['', '1', '2', '3', '4', '5', '6', '7', '8'] },
              { key: 'Responsibility', label: '職責', type: 'select', options: ['', '技術員', '技術責任者', '統括責任者'] },
              { key: 'Birth_Date', label: '生年月日', type: 'date' },
              { key: 'Blood_Type', label: '血液型', type: 'select', options: ['A', 'B', 'O', 'AB'] },
              { key: 'Address', label: '現住所', type: 'text' },
              { key: 'Phone', label: '携帯番号', type: 'tel' },
              { key: 'Emergency_Contact', label: '緊急連絡先', type: 'tel' },
              { key: 'Joined_Date', label: '入社年月日', type: 'date' },
              { key: 'Health_Check_Date', label: '直近健康診断日', type: 'date' },
              { key: 'Employment_Status', label: '雇用形態', type: 'select', options: ['正社員', '契約社員', '派遣', 'パート', 'その他'] }
            ],
            initialData: { ...s, Sei: sei, Mei: mei }
          });
        }

        // --- Staff Change Operations ---
        function openStaffChangeModal(s, changeType) {
          staffChangeModal.staffData = s;
          staffChangeModal.changeType = changeType;
          staffChangeModal.changeDate = new Date().toISOString().slice(0, 10);
          staffChangeModal.remarks = '';

          switch (changeType) {
            case '異動':
              staffChangeModal.fieldChanged = 'Org_ID';
              staffChangeModal.oldValue = s.Org_ID;
              // 組織を Type 別にグループ化して表示
              staffChangeModal.options = [];
              const orgTypes = ['部', '事業部', '事業所', '課', '係'];
              orgTypes.forEach(type => {
                const orgsOfType = organizations.value.filter(o => o.Is_Active !== '無効' && o.Type === type);
                if (orgsOfType.length > 0) {
                  staffChangeModal.options.push({ value: '__group__' + type, label: '── ' + type + ' ──', disabled: true });
                  orgsOfType.forEach(o => staffChangeModal.options.push({ value: o.Org_ID, label: getOrgFullPath(o.Org_ID) }));
                }
              });
              // Type未設定の組織
              const noType = organizations.value.filter(o => o.Is_Active !== '無効' && !orgTypes.includes(o.Type));
              if (noType.length > 0) {
                staffChangeModal.options.push({ value: '__group__other', label: '── その他 ──', disabled: true });
                noType.forEach(o => staffChangeModal.options.push({ value: o.Org_ID, label: getOrgFullPath(o.Org_ID) }));
              }
              break;
            case '昇進':
              staffChangeModal.fieldChanged = 'Position';
              staffChangeModal.oldValue = s.Position || '';
              staffChangeModal.options = ['主任', '係長', '課長補佐', '課長', '所長', '部長'].map(v => ({ value: v, label: v }));
              break;
            case '昇格':
              staffChangeModal.fieldChanged = 'Grade';
              staffChangeModal.oldValue = s.Grade || '';
              staffChangeModal.options = ['1', '2', '3', '4', '5', '6', '7', '8'].map(v => ({ value: v, label: v }));
              break;
            case '任命':
              staffChangeModal.fieldChanged = 'Responsibility';
              staffChangeModal.oldValue = s.Responsibility || '';
              staffChangeModal.options = ['技術員', '技術責任者', '統括責任者'].map(v => ({ value: v, label: v }));
              break;
          }
          staffChangeModal.newValue = staffChangeModal.oldValue;
          staffChangeModal.show = true;
        }

        function saveStaffChange() {
          if (!staffChangeModal.newValue || staffChangeModal.newValue === staffChangeModal.oldValue) {
            alert('新しい値を選択してください');
            return;
          }
          staffChangeModal.saving = true;
          const payload = {
            staffId: staffChangeModal.staffData.Staff_ID,
            staffEmail: staffChangeModal.staffData.Email,
            changeType: staffChangeModal.changeType,
            changeDate: staffChangeModal.changeDate,
            fieldChanged: staffChangeModal.fieldChanged,
            oldValue: staffChangeModal.oldValue,
            newValue: staffChangeModal.newValue,
            remarks: staffChangeModal.remarks
          };

          google.script.run
            .withSuccessHandler(res => {
              staffChangeModal.saving = false;
              if (res.success) {
                staffChangeModal.show = false;
                loadAllData();
              } else {
                alert('エラーが発生しました: ' + res.error);
              }
            })
            .applyStaffChange(payload);
        }

        // --- Load Data ---
        onMounted(() => {
          google.script.run
            .withSuccessHandler(data => {
              if (!data) {
                console.error('Data is null or undefined');
                loading.value = false;
                alert('データの読み込みに失敗しました: サーバーからの応答がありません');
                return;
              }
              facilities.value = data.facilities || [];
              equipment.value = data.equipment || [];
              inspectionRoutes.value = data.inspectionRoutes || [];
              routeDetails.value = data.routeDetails || []; // [NEW] v2
              inspectionResults.value = data.inspectionResults || [];
              construction.value = data.construction || [];
              items.value = data.items || [];
              inventoryLogs.value = data.inventoryLogs || [];
              staff.value = data.staff || [];
              organizations.value = data.organizations || [];
              contracts.value = data.contracts || [];
              qualifications.value = data.qualifications || [];
              qualApplications.value = data.qualApplications || [];
              staffChanges.value = data.staffChanges || [];

              // Dashboard quick stats
              const now = new Date();
              const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
              dashboardData.value = {
                recentAlerts: (data.inspectionResults || []).filter(r =>
                  r.Status === '異常' && new Date(r.Timestamp) >= thirtyDaysAgo
                ).length
              };

              loading.value = false;
            })
            .withFailureHandler(err => {
              console.error('Data load error:', err);
              loading.value = false;
              alert('データの読み込みに失敗しました: ' + err.message);
            })
            .getInitialData();
        });



        // Initialize
        onMounted(() => {
          // Mermaid Init
          mermaid.initialize({ startOnLoad: false, theme: 'default' });
        });

        // Watch for view change to 'blueprint'
        watch(currentView, (newVal) => {
          if (newVal === 'blueprint') {
            loadBlueprint();
          }
        });

        const loadBlueprint = () => {
          if (blueprintText.value) {
            // Already loaded, just render
            nextTick(() => {
              renderMermaid();
            });
            return;
          }

          google.script.run.withSuccessHandler((text) => {
            blueprintText.value = text;
            nextTick(() => {
              renderMermaid();
            });
          }).getSchemaDiagram();
        };

        const renderMermaid = () => {
          const container = document.getElementById('mermaid-container');
          if (container) {
            container.removeAttribute('data-processed'); // Force re-render if needed
            mermaid.run({ nodes: [container] });
          }
        };

        return {
          loading, currentView,
          facilities, equipment, inspectionRoutes, routeDetails, inspectionResults,
          construction, items, inventoryLogs, staff, dashboardData,
          organizations, contracts, qualifications, qualApplications,
          treeGroupBy, filters,
          selectedEquipment, currentTimeline, staffModal, editModal,
          statusCounts, treeData, inventoryWithStock, lowStockItems,
          officeList, filteredApplications, orderedOrganizations,
          selectedFacilityMapLink, selectedFacilityAddress,
          typeIcon, facilityName, formatDate, yearsFromInstall,
          calculateAge, calculateExperience, isExpiringSoon, isExpired,
          inspectionCountFor, constructionCountFor,
          selectEquipment, parseQualifications,
          openStaffModal, stockPercent, staffModalInspections,
          getStaffName, getQualName, getOrgFullPath, getOrgPathOnly,
          handleSave, handleDelete, addEquipment, editEquipment, addStaff, editStaff,
          showAddMenu, addFacility, addItem,
          staffTreeData, countAllStaff, qualTab,
          addQualification, editQualification, addQualApplication, editQualApplication,
          addOrganization, editOrganization,
          staffChanges, staffModalTab, staffChangeModal, openStaffChangeModal, saveStaffChange,
          getEquipmentName
        };
      }
    }).mount('#app');
  </script>
</body>

</html>